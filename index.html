---
layout: default
---

<div id="controls" class="controls">
   <div class="search-container">
      <input type="text" id="searchInput" title="Rechercher un lieu. La recherche fait disparaître les pins snon concernés par la recherche." placeholder="Rechercher un lieu...">
   </div>

   <div class="filter-container">
      <select id="tagFilter">
         <option value="" title="Liste des catérogies de lieux">Catégories</option>
      </select>
   </div>

   <div class="reset-container">
      <button id="resetFilters" class="btn btn-primary">Réinitialiser</button>
   </div>
</div>

<div id="map"></div>

<script>
// Données des lieux depuis Jekyll
const places = [
  {% for place in site.places %}
  {
    title: "{{ place.title | escape }}",
    lat: {{ place.lat }},
    lon: {{ place.lon }},
    tags: [{% if place.tags %}{% for tag in place.tags %}"{{ tag }}"{% unless forloop.last %},{% endunless %}{% endfor %}{% endif %}],
    url: "{{ place.url | relative_url }}",
    description: "{{ place.description | escape }}",
    image: "{{ place.image | relative_url }}"
  }{% unless forloop.last %},{% endunless %}
  {% endfor %}
];

// Variables globales
let map;
let markers = [];
let originalData = [...places];

// Icône SVG personnalisée
const svgIcon = L.divIcon({
  className: "custom-svg-pin",
  html: `
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="42" viewBox="0 0 30 42">
      <path d="M15 0C6.7 0 0 6.7 0 15c0 11.3 15 27 15 27s15-15.7 15-27C30 6.7 23.3 0 15 0z" fill="#202020"/>
      <circle cx="15" cy="15" r="6" fill="#fff"/>
    </svg>
  `,
  iconSize: [30, 42],
  iconAnchor: [15, 42],
  popupAnchor: [0, -42]
});

// Initialisation de la carte
function initMap() {
  map = L.map('map').setView([46.603354, 1.888334], 6);
  
   // OSM Bright via Stadia Maps
   L.tileLayer('https://tiles.stadiamaps.com/tiles/osm_bright/{z}/{x}/{y}{r}.png?api_key=cbccb69c-bd70-401f-a8ce-ade95addcf4d', {
      maxZoom: 20,
      attribution: '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>, ' +
                  '&copy; <a href="https://openmaptiles.org/">OpenMapTiles</a>, ' +
                  '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
   }).addTo(map);
  
  addMarkersToMap(places);
  
  if (places.length > 0) {
    const group = new L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.1));
  }
}

// Ajouter les marqueurs avec icône SVG
function addMarkersToMap(placesToShow) {
  markers.forEach(marker => map.removeLayer(marker));
  markers = [];
  
  placesToShow.forEach(place => {
    const popupContent = `
      <div class="popup-content">
        <h3><a href="${place.url}">${place.title}</a></h3>
        ${place.image ? `<img src="${place.image}" alt="${place.title}" style="height: 150px; object-fit: cover;">` : ''}
        ${place.description ? `<p>${place.description}</p>` : ''}
        ${place.tags.length > 0 ? `<div class="tags">${place.tags.map(tag => `<span class="tag">${tag}</span>`).join(' ')}</div>` : ''}
      </div>
    `;
    
    const marker = L.marker([place.lat, place.lon], { icon: svgIcon })
      .addTo(map)
      .bindPopup(popupContent);
    
    markers.push(marker);
  });
}

// Filtres
function initFilters() {
  const tagFilter = document.getElementById('tagFilter');
  const searchInput = document.getElementById('searchInput');
  const resetButton = document.getElementById('resetFilters');
  
  // Tri alphabétique insensible à la casse et aux accents
  const allTags = [...new Set(places.flatMap(place => place.tags))]
    .sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' }));
  
  allTags.forEach(tag => {
    const option = document.createElement('option');
    option.value = tag;
    option.textContent = tag;
    tagFilter.appendChild(option);
  });
  
  searchInput.addEventListener('input', filterPlaces);
  tagFilter.addEventListener('change', filterPlaces);
  resetButton.addEventListener('click', resetFilters);
}

function filterPlaces() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const selectedTag = document.getElementById('tagFilter').value;
  
  let filteredPlaces = originalData.filter(place => {
    const matchesSearch = place.title.toLowerCase().includes(searchTerm) || 
                          place.description.toLowerCase().includes(searchTerm);
    const matchesTag = !selectedTag || place.tags.includes(selectedTag);
    return matchesSearch && matchesTag;
  });
  
  addMarkersToMap(filteredPlaces);
  
  if (filteredPlaces.length > 0 && markers.length > 0) {
    const group = new L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.1));
  }
}

function resetFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('tagFilter').value = '';
  addMarkersToMap(originalData);
  
  if (originalData.length > 0) {
    const group = new L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.1));
  }
}

document.addEventListener('DOMContentLoaded', function() {
  initMap();
  initFilters();
});
</script>