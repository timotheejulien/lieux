---
layout: default
---

<div id="controls" class="controls">
  <div class="search-container">
    <input type="text" id="searchInput" placeholder="Rechercher un lieu...">
  </div>
  
  <div class="filter-container">
    <select id="tagFilter">
      <option value="">Tous les tags</option>
    </select>
  </div>
  
  <div class="reset-container">
    <button id="resetFilters" class="btn btn-primary">Réinitialiser</button>
  </div>
</div>

<div id="map"></div>

<script>
// Données des lieux depuis Jekyll
const places = [
  {% for place in site.places %}
  {
    title: "{{ place.title | escape }}",
    lat: {{ place.lat }},
    lon: {{ place.lon }},
    tags: [{% if place.tags %}{% for tag in place.tags %}"{{ tag }}"{% unless forloop.last %},{% endunless %}{% endfor %}{% endif %}],
    url: "{{ place.url | relative_url }}",
    description: "{{ place.description | escape }}",
    image: "{{ place.image | relative_url }}"
  }{% unless forloop.last %},{% endunless %}
  {% endfor %}
];

// Variables globales
let map;
let markers = [];
let originalData = [...places];

// Initialisation de la carte
function initMap() {
  // Créer la carte centrée sur la France
  map = L.map('map').setView([46.603354, 1.888334], 6);
  
  // Ajouter les tuiles OpenStreetMap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors',
    maxZoom: 18
  }).addTo(map);
  
  // Ajouter les marqueurs
  addMarkersToMap(places);
  
  // Ajuster la vue pour montrer tous les marqueurs
  if (places.length > 0) {
    const group = new L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.1));
  }
}

// Ajouter les marqueurs sur la carte
function addMarkersToMap(placesToShow) {
  // Supprimer les marqueurs existants
  markers.forEach(marker => map.removeLayer(marker));
  markers = [];
  
  placesToShow.forEach(place => {
    const popupContent = `
      <div class="popup-content">
        <h3><a href="${place.url}">${place.title}</a></h3>
        ${place.image ? `<img src="${place.image}" alt="${place.title}" style="width: 200px; height: 150px; object-fit: cover;">` : ''}
        ${place.description ? `<p>${place.description}</p>` : ''}
        ${place.tags.length > 0 ? `<div class="tags">${place.tags.map(tag => `<span class="tag">${tag}</span>`).join(' ')}</div>` : ''}
      </div>
    `;
    
    const marker = L.marker([place.lat, place.lon])
      .addTo(map)
      .bindPopup(popupContent);
    
    markers.push(marker);
  });
}

// Initialiser les filtres
function initFilters() {
  const tagFilter = document.getElementById('tagFilter');
  const searchInput = document.getElementById('searchInput');
  const resetButton = document.getElementById('resetFilters');
  
  // Récupérer tous les tags uniques
  const allTags = [...new Set(places.flatMap(place => place.tags))].sort();
  
  // Ajouter les options de tags
  allTags.forEach(tag => {
    const option = document.createElement('option');
    option.value = tag;
    option.textContent = tag;
    tagFilter.appendChild(option);
  });
  
  // Événements de filtrage
  searchInput.addEventListener('input', filterPlaces);
  tagFilter.addEventListener('change', filterPlaces);
  resetButton.addEventListener('click', resetFilters);
}

// Filtrer les lieux
function filterPlaces() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const selectedTag = document.getElementById('tagFilter').value;
  
  let filteredPlaces = originalData.filter(place => {
    const matchesSearch = place.title.toLowerCase().includes(searchTerm) || 
                         place.description.toLowerCase().includes(searchTerm);
    const matchesTag = !selectedTag || place.tags.includes(selectedTag);
    
    return matchesSearch && matchesTag;
  });
  
  addMarkersToMap(filteredPlaces);
  
  // Ajuster la vue si des résultats existent
  if (filteredPlaces.length > 0 && markers.length > 0) {
    const group = new L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.1));
  }
}

// Réinitialiser les filtres
function resetFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('tagFilter').value = '';
  addMarkersToMap(originalData);
  
  if (originalData.length > 0) {
    const group = new L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.1));
  }
}

// Initialiser quand le DOM est prêt
document.addEventListener('DOMContentLoaded', function() {
  initMap();
  initFilters();
});
</script>
