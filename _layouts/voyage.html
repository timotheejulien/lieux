---
layout: default
---
{% include nav-desktop.html %}
{% include nav-mobile.html %}

<main>
   <section class="container flex post-header">
      <div class="post-header-content">
         <h1>{{ page.title }}</h1>
         {% if page.description %}
            <p class="post-review-comment">{{ page.description }}</p>
         {% endif %}
      </div>
   </section>

   <section class="container">
      <ul class="grid-3 sort-by-alphabetical">
         {% assign selected_places = "" | split: "" %}

         {% for place_slug in page.places %}
            {% assign place = site.places | where: "slug", place_slug | first %}
            {% if place %}
               {% assign selected_places = selected_places | push: place %}
            {% endif %}
         {% endfor %}

         {% assign sorted_places = selected_places | sort: "title" %}

         {% for place in sorted_places %}
            <li>
               <a class="grid-cell-item" href="{{ place.url }}">
                  <div>
                     <span class="grid-item-label">{{ place.title }}</span>
                     <span class="grid-item-description">
                        {% if page.tags %}
                        {% for tag in place.tags %}
                           #{{ tag }}
                        {% endfor %}
                        {% endif %}
                     </span>
                  </div>
                  <svg width="20" height="21" viewBox="0 0 20 21" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.293 5.79302C14.6835 5.40249 15.3165 5.40249 15.707 5.79302L19.707 9.79302C20.0975 10.1835 20.0975 10.8166 19.707 11.2071L15.707 15.2071C15.3165 15.5976 14.6835 15.5976 14.293 15.2071C13.9024 14.8166 13.9024 14.1835 14.293 13.793L17.5859 10.5L14.293 7.20708C13.9024 6.81655 13.9024 6.18354 14.293 5.79302Z" fill=""/></svg>
               </a>
            </li>
         {% endfor %}
      </ul>
   </section>

   <section class="container voyage">
      <div id="voyage-map" style="height: 500px; margin-bottom: 2rem;"></div>
   </section>
</main>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // === 1. Initialisation de la carte ===
  const map = L.map('voyage-map').setView([46.603354, 1.888334], 5);

  // === 2. Définition des fonds de carte clair / sombre ===
  const lightTiles = L.tileLayer(
    'https://tiles.stadiamaps.com/tiles/osm_bright/{z}/{x}/{y}{r}.png?api_key=cbccb69c-bd70-401f-a8ce-ade95addcf4d',
    {
      maxZoom: 20,
      attribution:
        '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>, ' +
        '&copy; <a href="https://openmaptiles.org/">OpenMapTiles</a>, ' +
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }
  );

  const darkTiles = L.tileLayer(
    'https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png?api_key=cbccb69c-bd70-401f-a8ce-ade95addcf4d',
    {
      maxZoom: 20,
      attribution:
        '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>, ' +
        '&copy; <a href="https://openmaptiles.org/">OpenMapTiles</a>, ' +
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }
  );

  // === 3. Définition des icônes SVG ===
  const lightPinSVG = `
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="42" viewBox="0 0 30 42">
      <path d="M15 0C6.7 0 0 6.7 0 15c0 11.3 15 27 15 27s15-15.7 15-27C30 6.7 23.3 0 15 0z" fill="#202020"/>
      <circle cx="15" cy="15" r="6" fill="#fff"/>
    </svg>
  `;

  const darkPinSVG = `
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="42" viewBox="0 0 30 42">
      <path d="M15 0C6.7 0 0 6.7 0 15c0 11.3 15 27 15 27s15-15.7 15-27C30 6.7 23.3 0 15 0z" fill="#fff"/>
      <circle cx="15" cy="15" r="6" fill="#202020"/>
    </svg>
  `;

  function getPinIcon(isDark) {
    return L.divIcon({
      className: "custom-svg-pin",
      html: isDark ? darkPinSVG : lightPinSVG,
      iconSize: [30, 42],
      iconAnchor: [15, 42],
      popupAnchor: [0, -42]
    });
  }

  // === 4. Détermination du thème courant ===
  const prefersDark = window.matchMedia("(prefers-color-scheme: dark)");
  let isDark = prefersDark.matches;

  let currentTiles = isDark ? darkTiles : lightTiles;
  currentTiles.addTo(map);

  // === 5. Données Jekyll des lieux ===
  const voyagePlaces = [
    {% for place_slug in page.places %}
      {% assign place = site.places | where: "slug", place_slug | first %}
      {% if place %}
      {
        title: "{{ place.title | escape }}",
        lat: {{ place.lat }},
        lon: {{ place.lon }},
        url: "{{ place.url | relative_url }}",
        {% if place.image %}image: "{{ place.image | relative_url }}",{% endif %}
        {% if place.description %}description: "{{ place.description | escape }}",{% endif %}
        {% if place.tags %}tags: [{% for tag in place.tags %}"{{ tag }}"{% unless forloop.last %}, {% endunless %}{% endfor %}],{% else %}tags: [],{% endif %}
      }{% unless forloop.last %},{% endunless %}
      {% endif %}
    {% endfor %}
  ];

  // === 6. Ajout des marqueurs ===
  let markers = [];

  voyagePlaces.forEach(place => {
    const popupContent = `
      <div class="popup-content">
        <h3><a href="${place.url}">${place.title}</a></h3>
        ${place.image ? `<img data-src="${place.image}" alt="${place.title}" class="popup-image lazy-load" loading="lazy" style="height: 150px; object-fit: cover; width: 100%; border-radius: 4px;">` : ''}
        ${place.description ? `<p>${place.description}</p>` : ''}
        ${place.tags && place.tags.length > 0 ? `<div class="tags">${place.tags.map(tag => `<span class="tag">${tag}</span>`).join(' ')}</div>` : ''}
      </div>
    `;

    const marker = L.marker([place.lat, place.lon], { icon: getPinIcon(isDark) })
      .addTo(map)
      .bindPopup(popupContent);

    markers.push(marker);
  });

  if (markers.length > 0) {
    const group = new L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.1));
  }

  // === 7. Écoute du changement de thème ===
  prefersDark.addEventListener("change", (e) => {
    isDark = e.matches;

    // mise à jour du fond
    map.removeLayer(currentTiles);
    currentTiles = isDark ? darkTiles : lightTiles;
    currentTiles.addTo(map);

    // mise à jour des icônes
    markers.forEach(marker => marker.setIcon(getPinIcon(isDark)));
  });

  // === 8. Initialisation du lazy loading ===
  initLazyLoading();
});

// Lazy loading functionality
function initLazyLoading() {
   // Configuration de l'Intersection Observer
   const imageObserver = new IntersectionObserver((entries, observer) => {
       entries.forEach(entry => {
           if (entry.isIntersecting) {
               const element = entry.target;
               
               // Pour les images normales
               if (element.classList.contains('lazy-load')) {
                   const src = element.getAttribute('data-src');
                   if (src) {
                       element.src = src;
                       element.classList.add('loaded');
                       observer.unobserve(element);
                   }
               }
               
               // Pour les images de fond
               if (element.classList.contains('lazy-bg')) {
                   const bgImage = element.getAttribute('data-bg');
                   if (bgImage) {
                       element.style.backgroundImage = `url('${bgImage}')`;
                       element.classList.add('loaded');
                       observer.unobserve(element);
                   }
               }
           }
       });
   }, {
       root: null,
       rootMargin: '50px',
       threshold: 0.1
   });

   // Observer toutes les images lazy
   document.querySelectorAll('.lazy-load, .lazy-bg').forEach(img => {
       imageObserver.observe(img);
   });
}
</script>

{% include footer.html %}